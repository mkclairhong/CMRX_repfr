---

title: MSE-Based Model Fitting


keywords: fastai
sidebar: home_sidebar



nb_path: "06_Fitting_By_MSE.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: 06_Fitting_By_MSE.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We'll demo a way to fit models to datasets with item repetitions based on the mean squared error by comparison to a curve.</p>
<p>First we specify a loss function. This time, we use the mean squared error between CMR's simulated recall probability by lag function and the curve exhibited in the Lohnas dataset to see if we can find parameters that don't have this distortion.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Loss-Function">Loss Function<a class="anchor-link" href="#Loss-Function"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="cmr_rep_mse" class="doc_header"><code>cmr_rep_mse</code><a href="https://github.com/Solve-Memory/repfr/tree/{branch}/repfr/model_fitting.py#L120" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>cmr_rep_mse</code>(<strong><code>curve</code></strong>, <strong><code>presentations</code></strong>, <strong><code>list_types</code></strong>, <strong><code>experiment_count</code></strong>, <strong><code>presentation_count</code></strong>, <strong><code>encoding_drift_rate</code></strong>, <strong><code>start_drift_rate</code></strong>, <strong><code>recall_drift_rate</code></strong>, <strong><code>shared_support</code></strong>, <strong><code>item_support</code></strong>, <strong><code>learning_rate</code></strong>, <strong><code>primacy_scale</code></strong>, <strong><code>primacy_decay</code></strong>, <strong><code>stop_probability_scale</code></strong>, <strong><code>stop_probability_growth</code></strong>, <strong><code>choice_sensitivity</code></strong>)</p>
</blockquote>
<p>Apply organizational analyses to visually compare the behavior of the model
with these parameters against specified dataset.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>A wrapper "objective function" helps control which of relevant model parameters are fixed or free during model fitting.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="cmr_rep_mse_objective_function" class="doc_header"><code>cmr_rep_mse_objective_function</code><a href="https://github.com/Solve-Memory/repfr/tree/{branch}/repfr/model_fitting.py#L176" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>cmr_rep_mse_objective_function</code>(<strong><code>data_to_fit</code></strong>, <strong><code>presentations</code></strong>, <strong><code>list_types</code></strong>, <strong><code>experiment_count</code></strong>, <strong><code>list_length</code></strong>, <strong><code>fixed_parameters</code></strong>, <strong><code>free_parameters</code></strong>)</p>
</blockquote>
<p>Generates and returns an objective function for input to support search
through parameter space for ICMR model fit using an optimization function.</p>
<p>Arguments:</p>
<ul>
<li>fixed_parameters: dictionary mapping parameter names to values they'll
  be fixed to during search, overloaded by free_parameters if overlap</li>
<li>free_parameters: list of strings naming parameters for fit during search</li>
<li>data_to_fit: array where rows identify a unique trial of responses and
  columns corresponds to a unique recall index</li>
</ul>
<p>Returns a function that accepts a vector x specifying arbitrary values for
free parameters and returns evaluation of icmr_likelihood using the model
class, all parameters, and provided data.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Demo">Demo<a class="anchor-link" href="#Demo"> </a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now we test and time the loss function:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">repfr.datasets</span> <span class="kn">import</span> <span class="n">prepare_repdata</span>

<span class="n">trials</span><span class="p">,</span> <span class="n">events</span><span class="p">,</span> <span class="n">list_length</span><span class="p">,</span> <span class="n">presentations</span><span class="p">,</span> <span class="n">list_types</span><span class="p">,</span> <span class="n">rep_data</span><span class="p">,</span> <span class="n">subjects</span> <span class="o">=</span> <span class="n">prepare_repdata</span><span class="p">(</span>
    <span class="s1">&#39;data/repFR.mat&#39;</span><span class="p">)</span>

<span class="n">events</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>subject</th>
      <th>list</th>
      <th>item</th>
      <th>input</th>
      <th>output</th>
      <th>study</th>
      <th>recall</th>
      <th>repeat</th>
      <th>intrusion</th>
      <th>condition</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>1.0</td>
      <td>True</td>
      <td>True</td>
      <td>0</td>
      <td>False</td>
      <td>4</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>2</td>
      <td>2.0</td>
      <td>True</td>
      <td>True</td>
      <td>0</td>
      <td>False</td>
      <td>4</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1</td>
      <td>1</td>
      <td>2</td>
      <td>3</td>
      <td>3.0</td>
      <td>True</td>
      <td>True</td>
      <td>0</td>
      <td>False</td>
      <td>4</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1</td>
      <td>1</td>
      <td>3</td>
      <td>4</td>
      <td>4.0</td>
      <td>True</td>
      <td>True</td>
      <td>0</td>
      <td>False</td>
      <td>4</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1</td>
      <td>1</td>
      <td>4</td>
      <td>5</td>
      <td>5.0</td>
      <td>True</td>
      <td>True</td>
      <td>0</td>
      <td>False</td>
      <td>4</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">data_curve</span> <span class="o">=</span> <span class="n">recall_probability_by_lag</span><span class="p">(</span><span class="n">presentations</span><span class="p">[</span><span class="n">list_types</span><span class="o">==</span><span class="mi">4</span><span class="p">],</span> <span class="n">trials</span><span class="p">[</span><span class="n">list_types</span><span class="o">==</span><span class="mi">4</span><span class="p">])[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

<span class="n">parameters</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;presentation_count&#39;</span><span class="p">:</span> <span class="n">list_length</span><span class="p">,</span> 
<span class="p">}</span>

<span class="n">stored_result</span> <span class="o">=</span> <span class="p">[</span><span class="mf">8.44186613e-01</span><span class="p">,</span> <span class="mf">4.82922372e-01</span><span class="p">,</span> <span class="mf">9.64152301e-01</span><span class="p">,</span> <span class="mf">4.66982063e-02</span><span class="p">,</span>
       <span class="mf">2.22044605e-16</span><span class="p">,</span> <span class="mf">4.11208644e-01</span><span class="p">,</span> <span class="mf">4.38262927e+00</span><span class="p">,</span> <span class="mf">3.66252400e-01</span><span class="p">,</span>
       <span class="mf">2.51594034e-02</span><span class="p">,</span> <span class="mf">1.01416573e-01</span><span class="p">,</span> <span class="mf">1.14461246e+00</span><span class="p">]</span>

<span class="n">free_parameters</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;encoding_drift_rate&#39;</span><span class="p">,</span>
    <span class="s1">&#39;start_drift_rate&#39;</span><span class="p">,</span>
    <span class="s1">&#39;recall_drift_rate&#39;</span><span class="p">,</span>
    <span class="s1">&#39;shared_support&#39;</span><span class="p">,</span>
    <span class="s1">&#39;item_support&#39;</span><span class="p">,</span>
    <span class="s1">&#39;learning_rate&#39;</span><span class="p">,</span>
    <span class="s1">&#39;primacy_scale&#39;</span><span class="p">,</span>
    <span class="s1">&#39;primacy_decay&#39;</span><span class="p">,</span>
    <span class="s1">&#39;stop_probability_scale&#39;</span><span class="p">,</span>
    <span class="s1">&#39;stop_probability_growth&#39;</span><span class="p">,</span>
    <span class="s1">&#39;choice_sensitivity&#39;</span><span class="p">,]</span>

<span class="n">cmr_rep_mse</span><span class="p">(</span><span class="n">data_curve</span><span class="p">,</span> <span class="n">presentations</span><span class="p">[</span><span class="n">list_types</span><span class="o">==</span><span class="mi">4</span><span class="p">],</span> <span class="n">list_types</span><span class="p">[</span><span class="n">list_types</span><span class="o">==</span><span class="mi">4</span><span class="p">],</span> <span class="n">experiment_count</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> 
    <span class="o">**</span><span class="p">{</span><span class="o">**</span><span class="n">parameters</span><span class="p">,</span> <span class="o">**</span><span class="p">{</span><span class="n">free_parameters</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span><span class="n">stored_result</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">stored_result</span><span class="p">))}})</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>0.0018557822695404722</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>it

<span class="n">cmr_rep_mse</span><span class="p">(</span><span class="n">data_curve</span><span class="p">,</span> <span class="n">presentations</span><span class="p">[</span><span class="n">list_types</span><span class="o">==</span><span class="mi">4</span><span class="p">],</span> <span class="n">list_types</span><span class="p">[</span><span class="n">list_types</span><span class="o">==</span><span class="mi">4</span><span class="p">],</span> <span class="n">experiment_count</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> 
    <span class="o">**</span><span class="p">{</span><span class="o">**</span><span class="n">parameters</span><span class="p">,</span> <span class="o">**</span><span class="p">{</span><span class="n">free_parameters</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span><span class="n">stored_result</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">stored_result</span><span class="p">))}})</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Results">Results<a class="anchor-link" href="#Results"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">differential_evolution</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="n">free_parameters</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;encoding_drift_rate&#39;</span><span class="p">,</span>
    <span class="s1">&#39;start_drift_rate&#39;</span><span class="p">,</span>
    <span class="s1">&#39;recall_drift_rate&#39;</span><span class="p">,</span>
    <span class="s1">&#39;shared_support&#39;</span><span class="p">,</span>
    <span class="s1">&#39;item_support&#39;</span><span class="p">,</span>
    <span class="s1">&#39;learning_rate&#39;</span><span class="p">,</span>
    <span class="s1">&#39;primacy_scale&#39;</span><span class="p">,</span>
    <span class="s1">&#39;primacy_decay&#39;</span><span class="p">,</span>
    <span class="s1">&#39;stop_probability_scale&#39;</span><span class="p">,</span>
    <span class="s1">&#39;stop_probability_growth&#39;</span><span class="p">,</span>
    <span class="s1">&#39;choice_sensitivity&#39;</span><span class="p">,]</span>

<span class="n">parameters</span> <span class="o">=</span> <span class="p">{</span>
<span class="p">}</span>

<span class="n">lb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">eps</span>
<span class="n">ub</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">eps</span>

<span class="n">bounds</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="n">lb</span><span class="p">,</span> <span class="n">ub</span><span class="p">),</span>
    <span class="p">(</span><span class="n">lb</span><span class="p">,</span> <span class="n">ub</span><span class="p">),</span>
    <span class="p">(</span><span class="n">lb</span><span class="p">,</span> <span class="n">ub</span><span class="p">),</span>
    <span class="p">(</span><span class="n">lb</span><span class="p">,</span> <span class="n">ub</span><span class="p">),</span>
    <span class="p">(</span><span class="n">lb</span><span class="p">,</span> <span class="n">ub</span><span class="p">),</span>
    <span class="p">(</span><span class="n">lb</span><span class="p">,</span> <span class="n">ub</span><span class="p">),</span>
    <span class="p">(</span><span class="n">lb</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span>
    <span class="p">(</span><span class="n">lb</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span>
    <span class="p">(</span><span class="n">lb</span><span class="p">,</span> <span class="n">ub</span><span class="p">),</span>
    <span class="p">(</span><span class="n">lb</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
    <span class="p">(</span><span class="n">lb</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<span class="p">]</span>

<span class="c1"># cost function to be minimized</span>
<span class="c1"># ours scales inversely with the probability that the data could have been </span>
<span class="c1"># generated using the specified parameters and our model</span>
<span class="n">cost_function</span> <span class="o">=</span> <span class="n">cmr_rep_mse_objective_function</span><span class="p">(</span>
    <span class="n">data_curve</span><span class="p">,</span> <span class="n">presentations</span><span class="p">[</span><span class="n">list_types</span><span class="o">==</span><span class="mi">4</span><span class="p">],</span> <span class="n">list_types</span><span class="p">[</span><span class="n">list_types</span><span class="o">==</span><span class="mi">4</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="n">list_length</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">free_parameters</span><span class="p">)</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">differential_evolution</span><span class="p">(</span><span class="n">cost_function</span><span class="p">,</span> <span class="n">bounds</span><span class="p">,</span> <span class="n">disp</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">maxiter</span><span class="o">=</span><span class="mi">70</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">

<pre><code>     fun: 5.1299521657655926e-05
 message: 'Maximum number of iterations has been exceeded.'
    nfev: 11967
     nit: 70
 success: False
       x: array([8.53688927e-01, 3.91315203e-01, 1.60218200e-01, 1.34342503e-03,
       6.74953399e-01, 3.88335343e-01, 9.12294910e+00, 7.30879498e+01,
       2.46238233e-03, 2.73722040e-01, 3.47056155e+00])</code></pre>

</div>
</div>
</div>
</div>
 

